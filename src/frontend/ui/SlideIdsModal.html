<!-- ui/SlideIdsModal.html -->
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <style>
      .modal-content {
        padding: 20px;
      }
      .modal-footer {
        text-align: right;
        padding: 10px;
      }
      .modal-footer button {
        margin-left: 10px;
      }
      .input-field label {
        top: -20px;
        font-size: 14px;
        color: #9e9e9e;
      }
      .input-field input[type="text"] {
        margin-bottom: 20px;
      }
      .error-message {
        color: #F44336;
        font-size: 12px;
        margin-top: -15px;
        margin-bottom: 15px;
        display: none;
      }
      input.invalid {
        border-bottom: 1px solid #F44336 !important;
        box-shadow: 0 1px 0 0 #F44336 !important;
      }
      input.invalid + label {
        color: #F44336 !important;
      }
    </style>
  </head>
  <body>
    <div class="modal-content">
      <h5>Enter Slide IDs for "<?= assignmentDataObj.name ?>"</h5>
      <div class="input-field">
        <input 
          type="text" 
          id="referenceSlideId" 
          placeholder="Reference Slide ID" 
          value="<?= savedSlideIds.referenceSlideId || '' ?>"
          onkeyup="validateSlideIds()"
        >
        <label for="referenceSlideId" class="active">Reference Slide ID</label>
      </div>
      <div class="input-field">
        <input 
          type="text" 
          id="templateSlideId" 
          placeholder="Template Slide ID" 
          value="<?= savedSlideIds.templateSlideId || '' ?>"
          onkeyup="validateSlideIds()"
        >
        <label for="templateSlideId" class="active">Template Slide ID</label>
      </div>
      <div id="idMatchError" class="error-message">
        Reference and template slide IDs must be different
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn waves-effect waves-light" onclick="google.script.host.close()">Cancel</button>
      <button class="btn waves-effect waves-light" id="submitButton" onclick="saveAndRun()">Go</button>
    </div>

    <script>
      function validateSlideIds() {
        const referenceSlideId = document.getElementById('referenceSlideId').value.trim();
        const templateSlideId = document.getElementById('templateSlideId').value.trim();
        const errorMessage = document.getElementById('idMatchError');
        const inputs = [document.getElementById('referenceSlideId'), document.getElementById('templateSlideId')];
        
        // Check if both fields have values and if they match
        if (referenceSlideId && templateSlideId && referenceSlideId === templateSlideId) {
          // Show error
          errorMessage.style.display = 'block';
          inputs.forEach(input => input.classList.add('invalid'));
          return false;
        } else {
          // Clear error
          errorMessage.style.display = 'none';
          inputs.forEach(input => input.classList.remove('invalid'));
          return true;
        }
      }

      function saveAndRun() {
        const referenceSlideId = document.getElementById('referenceSlideId').value.trim();
        const templateSlideId = document.getElementById('templateSlideId').value.trim();

        if (!referenceSlideId || !templateSlideId) {
          alert('Please enter both Reference Slide ID and Template Slide ID.');
          return;
        }
        
        // Validate IDs don't match
        if (!validateSlideIds()) {
          M.toast({html: 'Reference and template slide IDs cannot be the same.', classes: 'red'});
          return;
        }

        const assignmentTitle = "<?= assignmentDataObj.name ?>";
        const assignmentId = "<?= assignmentDataObj.id ?>";

        const slideIds = {
          referenceSlideId: referenceSlideId,
          templateSlideId: templateSlideId
        };

        google.script.run
          .withFailureHandler(function(error) {
            alert('Error: ' + error.message);
          })
          .saveStartAndShowProgress(
            assignmentTitle,
            slideIds,
            assignmentId,
            referenceSlideId,
            templateSlideId
          );

        google.script.host.close();
      }

      // Initialise Materialise text fields and run initial validation
      document.addEventListener('DOMContentLoaded', function() {
        M.updateTextFields();
        validateSlideIds();
      });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  </body>
</html>
