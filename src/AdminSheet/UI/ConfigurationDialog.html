<!DOCTYPE html>
<html lang="en">

<head>
  <title>Assessment Bot — Configuration</title>
  <base target="_top">
  <!-- Materialize CSS for styling -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      max-width: 800px;
      padding-bottom: 80px;
      /* Ensures content is not hidden behind the button bar */
    }

    /* Tabs styling */
    .tabs .tab a {
      color: #42a5f5;
    }

    .tabs .tab a.active {
      background-color: #e3f2fd;
    }

    .tabs .indicator {
      background-color: #42a5f5;
    }

    .button-group {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      padding: 10px;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: flex-end;
    }

    .button-group .btn {
      margin-left: 10px;
    }

    /* Remove left padding from dropdown options */
    .select-dropdown li {
      padding-left: 0;
    }

    /* Loading overlay (reused from VersionSelectorModal) */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .updating-text {
      margin-top: 15px;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- The entire tab content is wrapped inside one form for configuration -->
    <!-- Disable native browser validation (some inputs live in hidden tabs and cannot be focused) -->
    <form id="config-form" novalidate>
      <div class="row">
        <div class="col s12">
          <ul class="tabs">
            <li class="tab col s3">
              <a href="#backendTab" class="active">Backend</a>
            </li>
            <li class="tab col s3">
              <a href="#advancedTab">Advanced</a>
            </li>
            <li class="tab col s3">
              <a href="#databaseTab">Database Settings</a>
            </li>
            <li class="tab col s3">
              <a href="#debugTab">Debug</a>
            </li>
          </ul>
        </div>

        <!-- Tab 1: Backend Configuration -->
        <div id="backendTab" class="col s12">
          <h5>Settings</h5>
          <div class="row">
            <div class="input-field col s12 m6">
              <input id="apiKey" name="apiKey" type="text" required>
              <label for="apiKey">API Key</label>
            </div>
            <div class="input-field col s12 m6">
              <input id="backendUrl" name="backendUrl" type="url" required>
              <label for="backendUrl">Backend URL</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 2: Advanced -->
      <div id="advancedTab" class="col s12">
        <h5>Advanced Settings</h5>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="backendAssessorBatchSize" name="backendAssessorBatchSize" type="number" min="1" max="500">
            <label for="backendAssessorBatchSize">Backend Assessor Batch Size (1–500)</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="slidesFetchBatchSize" name="slidesFetchBatchSize" type="number" min="1" max="100">
            <label for="slidesFetchBatchSize">Slides Fetch Batch Size (1–100)</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="updateDetailsUrl" name="updateDetailsUrl" type="url">
            <label for="updateDetailsUrl">Update Details URL</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="assessmentRecordTemplateId" name="assessmentRecordTemplateId" type="text">
            <label for="assessmentRecordTemplateId">Assessment Record Template ID</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="assessmentRecordDestinationFolder" name="assessmentRecordDestinationFolder" type="text">
            <label for="assessmentRecordDestinationFolder">Assessment Record Destination Folder</label>
          </div>
        </div>
        <!-- New field: Days Until Auth Revoke -->
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="daysUntilAuthRevoke" name="daysUntilAuthRevoke" type="number" min="1">
            <label for="daysUntilAuthRevoke">Days Until Auth Revoke (after this many days, authentication will be
              revoked)</label>
          </div>
        </div>
      </div>

      <!-- Tab 3: Database Settings -->
      <div id="databaseTab" class="col s12">
        <h5>Database Settings</h5>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="jsonDbMasterIndexKey" name="jsonDbMasterIndexKey" type="text" required>
            <label for="jsonDbMasterIndexKey">Master Index Key</label>
            <span class="helper-text">Unique key used to identify the JsonDb master index.</span>
          </div>
          <div class="input-field col s12 m6">
            <input id="jsonDbRootFolderId" name="jsonDbRootFolderId" type="text">
            <label for="jsonDbRootFolderId">Root Folder ID (optional)</label>
            <span class="helper-text">Leave blank to allow automatic discovery of the Drive folder.</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="jsonDbLockTimeoutMs" name="jsonDbLockTimeoutMs" type="number" min="1000" max="600000">
            <label for="jsonDbLockTimeoutMs">Lock Timeout (ms, 1,000–600,000)</label>
          </div>
          <div class="input-field col s12 m6">
            <select id="jsonDbLogLevel" name="jsonDbLogLevel">
              <option value="" disabled selected>Select a log level</option>
              <option value="DEBUG">Debug</option>
              <option value="INFO">Info</option>
              <option value="WARN">Warn</option>
              <option value="ERROR">Error</option>
            </select>
            <label for="jsonDbLogLevel">Log Level</label>
          </div>
        </div>
        <div class="row">
          <div class="col s12 m6">
            <div class="switch">
              <label>
                Off
                <input id="jsonDbBackupOnInitialise" name="jsonDbBackupOnInitialise" type="checkbox">
                <span class="lever"></span>
                On
              </label>
            </div>
            <span class="helper-text">Create a backup of the database the first time it initialises.</span>
          </div>
        </div>
      </div>

  <!-- Tab 4: Debug (Classroom Selector) -->
      <div id="debugTab" class="col s12">
        <h5>Select Your Classroom</h5>
        <div class="input-field">
          <select id="classrooms" name="classrooms">
            <option value="" disabled selected>Choose your classroom</option>
            <? for (let i = 0; i < classrooms.length; i++) { ?>
            <option value="<?= classrooms[i].id ?>" data-name="<?= classrooms[i].name ?>">
              <?= classrooms[i].name ?>
            </option>
            <? } ?>
          </select>
          <label for="classrooms">Classroom</label>
        </div>
      </div>
  </div>
  </form>
  </div>

  <!-- Loading overlay (matches VersionSelectorModal) -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="spinner"></div>
    <div class="updating-text">Updating...</div>
  </div>

  <!-- Fixed button group for configuration (applies to Langflow and Advanced tabs) -->
  <div class="button-group">
    <a href="#!" class="btn grey lighten-1" onclick="google.script.host.close()">Cancel</a>
    <button class="btn blue waves-effect waves-light" type="submit" form="config-form">
      <i class="material-icons right">save</i> Save
    </button>
  </div>

  <!-- Materialize JS and initialisation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var tabs = document.querySelectorAll('.tabs');
      M.Tabs.init(tabs);
      M.updateTextFields();
      var selects = document.querySelectorAll('select');
      M.FormSelect.init(selects);

      // Load existing configuration
      google.script.run
        .withSuccessHandler(populateForm)
        .withFailureHandler(function (error) {
          M.toast({ html: `Error loading configuration: ${error.message}`, classes: 'red' });
        })
        .getConfiguration();

      // Load classrooms
      google.script.run
        .withSuccessHandler(populateClassrooms)
        .withFailureHandler(function (error) {
          M.toast({ html: `Error loading classrooms: ${error.message}`, classes: 'red' });
        })
        .getClassrooms();

    });

    function populateForm(data) {
      if (data.loadError) {
        console.error('Configuration load errors:', data.loadError);
        M.toast({ html: `Some configuration values failed to load: ${data.loadError}`, classes: 'orange', displayLength: 8000 });
      }
      // Handle API key specially: backend returns a redacted API key and a `hasApiKey` boolean.
      // We rely on `hasApiKey` to determine whether a key exists. If a key exists, show the
      // masked apiKey as a placeholder (so the user sees that a key is stored) but do NOT
      // populate the input value with that masked string. If the user leaves the field blank
      // it will be interpreted as "keep existing key". If they enter a value it's treated as
      // a new key. If they explicitly clear the field (and the original had no key) it will
      // attempt to save an empty string (explicit clear).
      const apiKeyEl = document.getElementById('apiKey');
      window._apiKeyWasRedacted = !!data.hasApiKey;
      if (data.hasApiKey) {
        // Show masked representation as placeholder; do not set value.
        apiKeyEl.value = '';
        apiKeyEl.placeholder = data.apiKey || 'Saved (hidden)';
      } else {
        apiKeyEl.value = data.apiKey || '';
        apiKeyEl.placeholder = '';
      }
      document.getElementById('backendUrl').value = data.backendUrl || '';
      // Populate renamed backend assessor batch size
      const backendBatchInput = document.getElementById('backendAssessorBatchSize');
      if (backendBatchInput) {
        backendBatchInput.value = data.backendAssessorBatchSize || 20;
      }
      document.getElementById('slidesFetchBatchSize').value = data.slidesFetchBatchSize || 20;
      document.getElementById('updateDetailsUrl').value = data.updateDetailsUrl || '';
      document.getElementById('assessmentRecordTemplateId').value = data.assessmentRecordTemplateId || '';
      document.getElementById('assessmentRecordDestinationFolder').value = data.assessmentRecordDestinationFolder || '';
      document.getElementById('daysUntilAuthRevoke').value = data.daysUntilAuthRevoke || 60;
      document.getElementById('jsonDbMasterIndexKey').value = data.jsonDbMasterIndexKey || '';
      document.getElementById('jsonDbRootFolderId').value = data.jsonDbRootFolderId || '';
      document.getElementById('jsonDbLockTimeoutMs').value = data.jsonDbLockTimeoutMs || 10000;
      const logLevelSelect = document.getElementById('jsonDbLogLevel');
      if (logLevelSelect) {
        logLevelSelect.value = data.jsonDbLogLevel || '';
        M.FormSelect.init(logLevelSelect);
      }
      document.getElementById('jsonDbBackupOnInitialise').checked = !!data.jsonDbBackupOnInitialise;
      M.updateTextFields();
    }

    function populateClassrooms(classrooms) {
      const select = document.getElementById('classrooms');
      if (!classrooms || classrooms.length === 0) {
        console.warn("No classrooms found.");
        return;
      }

      // Clear existing options
      select.innerHTML = '<option value="" disabled selected>Choose your classroom</option>';

      // Add new options
      classrooms.forEach(classroom => {
        const option = document.createElement('option');
        option.value = classroom.id;
        option.dataset.name = classroom.name;
        option.textContent = classroom.name;
        select.appendChild(option);
      });
      // NO Materialize initialization here; it's done in the success handler
      var selects = document.querySelectorAll('select');
      M.FormSelect.init(selects);
    }

    // Shared helper to validate integer ranges; returns parsed value or null (and focuses tab + shows toast on failure)
    function validateIntRange(id, min, max, label, focusTabFn) {
      const el = document.getElementById(id);
      const val = Number.parseInt(el.value, 10);
      if (isNaN(val) || val < min || val > max) {
        if (typeof focusTabFn === 'function') focusTabFn();
        M.toast({ html: `${label} must be an integer between ${min} and ${max}.`, classes: 'orange' });
        el.focus();
        return null;
      }
      return val;
    }


    document.getElementById('config-form').addEventListener('submit', function (event) {
      event.preventDefault();
      // Custom validation: browser native validation can fail when an invalid control
      // is inside a hidden tab (not focusable). Use a small JS validator and switch
      // to the backend tab if required fields are missing.
      const apiKeyEl = document.getElementById('apiKey');
      const backendUrlEl = document.getElementById('backendUrl');

      function focusBackendTab() {
        try {
          var tabsInstance = M.Tabs.getInstance(document.querySelector('.tabs'));
          if (tabsInstance && typeof tabsInstance.select === 'function') {
            tabsInstance.select('backendTab');
          }
        } catch (e) {
          // Log for debugging; do not surface errors to users
          console.debug('focusBackendTab: failed to select backend tab', e?.message || e);
        }
      }

      function focusTab(tabId) {
        try {
          const tabsInstance = M.Tabs.getInstance(document.querySelector('.tabs'));
          if (tabsInstance && typeof tabsInstance.select === 'function') {
            tabsInstance.select(tabId);
          }
        } catch (e) {
          // Log for debugging; do not surface errors to users
          console.debug('focusTab: failed to select tab', tabId, e?.message || e);
        }
      }

      function focusAdvancedTab() {
        focusTab('advancedTab');
      }

      function focusDatabaseTab() {
        focusTab('databaseTab');
      }

      function isValidUrl(u) {
        if (!u) return false;
        try {
          new URL(u);
          return true;
        } catch (e) {
          console.debug('isValidUrl: invalid URL', u, e?.message || e);
          return false;
        }
      }

      // Require an API key only if none is present on the server and the user hasn't provided one.
      // If the server already has a key (data.hasApiKey true), leaving the field empty means
      // "keep existing key" and should be allowed.
      if (!window._apiKeyWasRedacted && !apiKeyEl.value.trim()) {
        focusBackendTab();
        M.toast({ html: 'API Key is required.', classes: 'orange' });
        apiKeyEl.focus();
        return;
      }

      if (!backendUrlEl.value.trim() || !isValidUrl(backendUrlEl.value.trim())) {
        focusBackendTab();
        M.toast({ html: 'Please provide a valid Backend URL.', classes: 'orange' });
        backendUrlEl.focus();
        return;
      }

      const masterIndexInput = document.getElementById('jsonDbMasterIndexKey');
      const masterIndexKey = masterIndexInput.value.trim();
      if (!masterIndexKey) {
        focusDatabaseTab();
        M.toast({ html: 'Master Index Key is required.', classes: 'orange' });
        masterIndexInput.focus();
        return;
      }

      const logLevelValue = document.getElementById('jsonDbLogLevel').value;
      const allowedLogLevels = ['DEBUG', 'INFO', 'WARN', 'ERROR'];
      if (!allowedLogLevels.includes(logLevelValue)) {
        focusDatabaseTab();
        M.toast({ html: 'Please select a valid log level.', classes: 'orange' });
        return;
      }

      const lockTimeoutVal = validateIntRange('jsonDbLockTimeoutMs', 1000, 600000, 'Lock Timeout (ms)', focusDatabaseTab);
      if (lockTimeoutVal === null) return;

      const rootFolderInput = document.getElementById('jsonDbRootFolderId');
      const rootFolderId = rootFolderInput.value.trim();
      const driveIdPattern = /^[A-Za-z0-9-_]{10,}$/;
      if (rootFolderId && !driveIdPattern.test(rootFolderId)) {
        focusDatabaseTab();
        M.toast({ html: 'Root Folder ID must be a valid Google Drive identifier.', classes: 'orange' });
        rootFolderInput.focus();
        return;
      }

      // Validate integer range fields via shared helper
      const slidesVal = validateIntRange('slidesFetchBatchSize', 1, 100, 'Slides Fetch Batch Size', focusAdvancedTab);
      if (slidesVal === null) return;
      const backendBatchVal = validateIntRange('backendAssessorBatchSize', 1, 500, 'Backend Assessor Batch Size', focusAdvancedTab);
      if (backendBatchVal === null) return;
      const daysUntilAuthRevokeVal = validateIntRange('daysUntilAuthRevoke', 1, 365, 'Days Until Auth Revoke', focusAdvancedTab);
      if (daysUntilAuthRevokeVal === null) return;

      const select = document.getElementById('classrooms');
      const classroom = select.value ? {
        courseId: select.value,
        courseName: select.options[select.selectedIndex].dataset.name
      } : null;

      const formData = {
        // Only include apiKey in payload if the user actually entered a value. If the backend
        // returned a redacted value and the user didn't change the input, we leave apiKey
        // undefined so the server knows to keep the existing key.
        // Note: we still allow the user to clear the key by entering an empty string explicitly
        // (if you want to prevent clearing, adjust logic accordingly).
        apiKey: (function () {
          const v = document.getElementById('apiKey').value.trim();
          if (v) return v; // user provided a new key
          // no value entered — if the original was redacted, omit apiKey from payload
          if (window._apiKeyWasRedacted) return undefined;
          // original wasn't redacted and user cleared the field -> send empty string (explicit clear)
          return '';
        })(),
        backendUrl: document.getElementById('backendUrl').value.trim(),
        backendAssessorBatchSize: backendBatchVal,
        updateDetailsUrl: document.getElementById('updateDetailsUrl').value.trim(),
        assessmentRecordTemplateId: document.getElementById('assessmentRecordTemplateId').value.trim(),
        assessmentRecordDestinationFolder: document.getElementById('assessmentRecordDestinationFolder').value.trim(),
        slidesFetchBatchSize: slidesVal,
        daysUntilAuthRevoke: daysUntilAuthRevokeVal,
        jsonDbMasterIndexKey: masterIndexKey,
        jsonDbLockTimeoutMs: lockTimeoutVal,
        jsonDbLogLevel: logLevelValue,
        jsonDbBackupOnInitialise: document.getElementById('jsonDbBackupOnInitialise').checked,
        jsonDbRootFolderId: rootFolderId,
        classroom: classroom
      };

      // Show loading overlay while saving
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'flex';

      google.script.run
        .withSuccessHandler(function (result) {
          if (overlay) overlay.style.display = 'none';
          if (!result) {
            M.toast({ html: 'Configuration save returned no result.', classes: 'orange' });
            return;
          }
          if (result.success) {
            M.toast({ html: 'Configuration saved successfully.', classes: 'green' });
            google.script.host.close();
          } else {
            console.error('Configuration save failed:', result.error);
            M.toast({ html: `Error saving configuration: ${result.error}`, classes: 'orange', displayLength: 8000 });
          }
        })
        .withFailureHandler(function (error) {
          if (overlay) overlay.style.display = 'none';
          M.toast({ html: `Error saving configuration: ${error.message}`, classes: 'red' });
        })
        .saveConfiguration(formData);
    });
  </script>
</body>

</html>