<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <!-- Materialize CSS for styling -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      max-width: 800px;
      padding-bottom: 80px;
      /* Ensures content is not hidden behind the button bar */
    }

    /* Tabs styling */
    .tabs .tab a {
      color: #42a5f5;
    }

    .tabs .tab a.active {
      background-color: #e3f2fd;
    }

    .tabs .indicator {
      background-color: #42a5f5;
    }

    .button-group {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      padding: 10px;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: flex-end;
    }

    .button-group .btn {
      margin-left: 10px;
    }

    /* Remove left padding from dropdown options */
    .select-dropdown li {
      padding-left: 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- The entire tab content is wrapped inside one form for configuration -->
    <!-- Disable native browser validation (some inputs live in hidden tabs and cannot be focused) -->
    <form id="config-form" novalidate>
      <div class="row">
        <div class="col s12">
          <ul class="tabs">
            <li class="tab col s4">
              <a href="#backendTab" class="active">Backend</a>
            </li>
            <li class="tab col s4">
              <a href="#advancedTab">Advanced</a>
            </li>
            <li class="tab col s4">
              <a href="#debugTab">Debug</a>
            </li>
          </ul>
        </div>

        <!-- Tab 1: Backend Configuration -->
        <div id="backendTab" class="col s12">
          <h5>Settings</h5>
          <div class="row">
            <div class="input-field col s12 m6">
              <input id="apiKey" name="apiKey" type="text" required>
              <label for="apiKey">API Key</label>
            </div>
            <div class="input-field col s12 m6">
              <input id="backendUrl" name="backendUrl" type="url" required>
              <label for="backendUrl">Backend URL</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 2: Advanced -->
      <div id="advancedTab" class="col s12">
        <h5>Advanced Settings</h5>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="backendAssessorBatchSize" name="backendAssessorBatchSize" type="number" min="1" max="500">
            <label for="backendAssessorBatchSize">Backend Assessor Batch Size (1–500)</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="slidesFetchBatchSize" name="slidesFetchBatchSize" type="number" min="1" max="100">
            <label for="slidesFetchBatchSize">Slides Fetch Batch Size (1–100)</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="updateDetailsUrl" name="updateDetailsUrl" type="url">
            <label for="updateDetailsUrl">Update Details URL</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="assessmentRecordTemplateId" name="assessmentRecordTemplateId" type="text">
            <label for="assessmentRecordTemplateId">Assessment Record Template ID</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="assessmentRecordDestinationFolder" name="assessmentRecordDestinationFolder" type="text">
            <label for="assessmentRecordDestinationFolder">Assessment Record Destination Folder</label>
          </div>
        </div>
        <!-- New field: Days Until Auth Revoke -->
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="daysUntilAuthRevoke" name="daysUntilAuthRevoke" type="number" min="1">
            <label for="daysUntilAuthRevoke">Days Until Auth Revoke (after this many days, authentication will be
              revoked)</label>
          </div>
        </div>
      </div>

      <!-- Tab 3: Debug (Classroom Selector) -->
      <div id="debugTab" class="col s12">
        <h5>Select Your Classroom</h5>
        <div class="input-field">
          <select id="classrooms" name="classrooms">
            <option value="" disabled selected>Choose your classroom</option>
            <? for (let i = 0; i < classrooms.length; i++) { ?>
            <option value="<?= classrooms[i].id ?>" data-name="<?= classrooms[i].name ?>">
              <?= classrooms[i].name ?>
            </option>
            <? } ?>
          </select>
          <label for="classrooms">Classroom</label>
        </div>
      </div>
  </div>
  </form>
  </div>

  <!-- Fixed button group for configuration (applies to Langflow and Advanced tabs) -->
  <div class="button-group">
    <a href="#!" class="btn grey lighten-1" onclick="google.script.host.close()">Cancel</a>
    <button class="btn blue waves-effect waves-light" type="submit" form="config-form">
      <i class="material-icons right">save</i> Save
    </button>
  </div>

  <!-- Materialize JS and initialisation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var tabs = document.querySelectorAll('.tabs');
      M.Tabs.init(tabs);
      M.updateTextFields();
      var selects = document.querySelectorAll('select');
      M.FormSelect.init(selects);

      // Load existing configuration
      google.script.run
        .withSuccessHandler(populateForm)
        .withFailureHandler(function (error) {
          M.toast({ html: `Error loading configuration: ${error.message}`, classes: 'red' });
        })
        .getConfiguration();

      // Load classrooms
      google.script.run
        .withSuccessHandler(populateClassrooms)
        .withFailureHandler(function (error) {
          M.toast({ html: `Error loading classrooms: ${error.message}`, classes: 'red' });
        })
        .getClassrooms();

    });

    function populateForm(data) {
      if (data.loadError) {
        console.error('Configuration load errors:', data.loadError);
        M.toast({ html: `Some configuration values failed to load: ${data.loadError}`, classes: 'orange', displayLength: 8000 });
      }
      document.getElementById('apiKey').value = data.apiKey || '';
      document.getElementById('backendUrl').value = data.backendUrl || '';
      // Populate renamed backend assessor batch size
      const backendBatchInput = document.getElementById('backendAssessorBatchSize');
      if (backendBatchInput) {
        backendBatchInput.value = data.backendAssessorBatchSize || 20;
      }
      document.getElementById('slidesFetchBatchSize').value = data.slidesFetchBatchSize || 20;
      document.getElementById('updateDetailsUrl').value = data.updateDetailsUrl || '';
      document.getElementById('assessmentRecordTemplateId').value = data.assessmentRecordTemplateId || '';
      document.getElementById('assessmentRecordDestinationFolder').value = data.assessmentRecordDestinationFolder || '';
      document.getElementById('daysUntilAuthRevoke').value = data.daysUntilAuthRevoke || 60;
      M.updateTextFields();
    }

    function populateClassrooms(classrooms) {
      const select = document.getElementById('classrooms');
      if (!classrooms || classrooms.length === 0) {
        console.warn("No classrooms found.");
        return;
      }

      // Clear existing options
      select.innerHTML = '<option value="" disabled selected>Choose your classroom</option>';

      // Add new options
      classrooms.forEach(classroom => {
        const option = document.createElement('option');
        option.value = classroom.id;
        option.dataset.name = classroom.name;
        option.textContent = classroom.name;
        select.appendChild(option);
      });
      // NO Materialize initialization here; it's done in the success handler
      var selects = document.querySelectorAll('select');
      M.FormSelect.init(selects);
    }

    // Shared helper to validate integer ranges; returns parsed value or null (and focuses tab + shows toast on failure)
    function validateIntRange(id, min, max, label, focusTabFn) {
      const el = document.getElementById(id);
      const val = parseInt(el.value, 10);
      if (isNaN(val) || val < min || val > max) {
        if (typeof focusTabFn === 'function') focusTabFn();
        M.toast({ html: `${label} must be an integer between ${min} and ${max}.`, classes: 'orange' });
        el.focus();
        return null;
      }
      return val;
    }


    document.getElementById('config-form').addEventListener('submit', function (event) {
      event.preventDefault();
      // Custom validation: browser native validation can fail when an invalid control
      // is inside a hidden tab (not focusable). Use a small JS validator and switch
      // to the backend tab if required fields are missing.
      const apiKeyEl = document.getElementById('apiKey');
      const backendUrlEl = document.getElementById('backendUrl');

      function focusBackendTab() {
        try {
          var tabsInstance = M.Tabs.getInstance(document.querySelector('.tabs'));
          if (tabsInstance && typeof tabsInstance.select === 'function') {
            tabsInstance.select('backendTab');
          }
        } catch (e) {
          // ignore
        }
      }

      function focusAdvancedTab() {
        try {
          var tabsInstance = M.Tabs.getInstance(document.querySelector('.tabs'));
          if (tabsInstance && typeof tabsInstance.select === 'function') {
            tabsInstance.select('advancedTab');
          }
        } catch (e) {
          // ignore
        }
      }

      function isValidUrl(u) {
        if (!u) return false;
        try {
          new URL(u);
          return true;
        } catch (e) {
          return false;
        }
      }

      if (!apiKeyEl.value.trim()) {
        focusBackendTab();
        M.toast({ html: 'API Key is required.', classes: 'orange' });
        apiKeyEl.focus();
        return;
      }

      if (!backendUrlEl.value.trim() || !isValidUrl(backendUrlEl.value.trim())) {
        focusBackendTab();
        M.toast({ html: 'Please provide a valid Backend URL.', classes: 'orange' });
        backendUrlEl.focus();
        return;
      }

      // Validate integer range fields via shared helper
      const slidesVal = validateIntRange('slidesFetchBatchSize', 1, 100, 'Slides Fetch Batch Size', focusAdvancedTab);
      if (slidesVal === null) return;
      const backendBatchVal = validateIntRange('backendAssessorBatchSize', 1, 500, 'Backend Assessor Batch Size', focusAdvancedTab);
      if (backendBatchVal === null) return;
      const daysUntilAuthRevokeVal = validateIntRange('daysUntilAuthRevoke', 1, 365, 'Days Until Auth Revoke', focusAdvancedTab);
      if (daysUntilAuthRevokeVal === null) return;

      const select = document.getElementById('classrooms');
      const classroom = select.value ? {
        courseId: select.value,
        courseName: select.options[select.selectedIndex].dataset.name
      } : null;

      const formData = {
        apiKey: document.getElementById('apiKey').value.trim(),
        backendUrl: document.getElementById('backendUrl').value.trim(),
        backendAssessorBatchSize: backendBatchVal,
        updateDetailsUrl: document.getElementById('updateDetailsUrl').value.trim(),
        assessmentRecordTemplateId: document.getElementById('assessmentRecordTemplateId').value.trim(),
        assessmentRecordDestinationFolder: document.getElementById('assessmentRecordDestinationFolder').value.trim(),
        slidesFetchBatchSize: slidesVal,
        daysUntilAuthRevoke: daysUntilAuthRevokeVal,
        classroom: classroom
      };

      google.script.run
        .withSuccessHandler(function (result) {
          if (!result) {
            M.toast({ html: 'Configuration save returned no result.', classes: 'orange' });
            return;
          }
          if (result.success) {
            M.toast({ html: 'Configuration saved successfully.', classes: 'green' });
            google.script.host.close();
          } else {
            console.error('Configuration save failed:', result.error);
            M.toast({ html: `Error saving configuration: ${result.error}`, classes: 'orange', displayLength: 8000 });
          }
        })
        .withFailureHandler(function (error) {
          M.toast({ html: `Error saving configuration: ${error.message}`, classes: 'red' });
        })
        .saveConfiguration(formData);
    });
  </script>
</body>

</html>