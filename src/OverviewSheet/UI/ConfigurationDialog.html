<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <!-- Material Web CSS and JavaScript -->
  <link rel="stylesheet" href="../ui/assets/material-web.css">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      max-width: 800px;
      padding-bottom: 80px;
      /* Ensures content is not hidden behind the button bar */
    }

    /* Tab content styling */
    .tab-content {
      display: none;
      padding: 20px 0;
    }

    .tab-content.active {
      display: block;
    }

    .button-group {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      padding: 10px;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: flex-end;
    }

    .button-group md-filled-button,
    .button-group md-outlined-button {
      margin-left: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- The entire tab content is wrapped inside one form for configuration -->
    <form id="config-form">
      <div class="row">
        <div class="col s12">
          <md-tabs>
            <md-primary-tab id="backend-tab" active onclick="showTab('backendTab')">Backend</md-primary-tab>
            <md-primary-tab id="advanced-tab" onclick="showTab('advancedTab')">Advanced</md-primary-tab>
            <md-primary-tab id="debug-tab" onclick="showTab('debugTab')">Debug</md-primary-tab>
          </md-tabs>
        </div>

        <!-- Tab 1: Backend Configuration -->
        <div id="backendTab" class="col s12 tab-content active">
          <h5>Settings</h5>
          <div class="row">
            <div class="input-field col s12 m6">
              <md-outlined-text-field id="apiKey" name="apiKey" label="API Key" required></md-outlined-text-field>
            </div>
            <div class="input-field col s12 m6">
              <md-outlined-text-field id="backendUrl" name="backendUrl" label="Backend URL" type="url" required></md-outlined-text-field>
            </div>
          </div>
        </div>

        <!-- Tab 2: Advanced -->
        <div id="advancedTab" class="col s12 tab-content">
          <h5>Advanced Settings</h5>
          <div class="row">
            <div class="input-field col s12 m6">
              <md-outlined-text-field id="batchSize" name="batchSize" label="Batch Size" type="number" min="1"></md-outlined-text-field>
            </div>
            <div class="input-field col s12 m6">
              <md-outlined-text-field id="updateDetailsUrl" name="updateDetailsUrl" label="Update Details URL" type="url"></md-outlined-text-field>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12 m6">
              <md-outlined-text-field id="assessmentRecordTemplateId" name="assessmentRecordTemplateId" label="Assessment Record Template ID"></md-outlined-text-field>
            </div>
            <div class="input-field col s12 m6">
              <md-outlined-text-field id="assessmentRecordDestinationFolder" name="assessmentRecordDestinationFolder" label="Assessment Record Destination Folder"></md-outlined-text-field>
            </div>
          </div>
          <!-- New field: Days Until Auth Revoke -->
          <div class="row">
            <div class="input-field col s12 m6">
              <md-outlined-text-field id="daysUntilAuthRevoke" name="daysUntilAuthRevoke" label="Days Until Auth Revoke (after this many days, authentication will be revoked)" type="number" min="1"></md-outlined-text-field>
            </div>
          </div>
        </div>

        <!-- Tab 3: Debug (Classroom Selector) -->
        <div id="debugTab" class="col s12 tab-content">
          <h5>Select Your Classroom</h5>
          <div class="input-field">
            <md-outlined-select id="classrooms" name="classrooms" label="Classroom">
              <md-select-option value="" disabled selected>
                <div slot="headline">Choose your classroom</div>
              </md-select-option>
              <? for (let i = 0; i < classrooms.length; i++) { ?>
              <md-select-option value="<?= classrooms[i].id ?>" data-name="<?= classrooms[i].name ?>">
                <div slot="headline"><?= classrooms[i].name ?></div>
              </md-select-option>
              <? } ?>
            </md-outlined-select>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Fixed button group for configuration (applies to all tabs) -->
  <div class="button-group">
    <md-outlined-button onclick="google.script.host.close()">Cancel</md-outlined-button>
    <md-filled-button type="submit" form="config-form">
      <md-icon slot="icon">save</md-icon>
      Save
    </md-filled-button>
  </div>

  <!-- Material Web JavaScript -->
  <script src="../ui/assets/material-web.js"></script>
  <script>
    // Tab switching functionality
    function showTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabId).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Load existing configuration
      google.script.run
        .withSuccessHandler(populateForm)
        .withFailureHandler(function (error) {
          showToast(`Error loading configuration: ${error.message}`, 'error');
        })
        .getConfiguration();

        // Load classrooms
      google.script.run
        .withSuccessHandler(populateClassrooms)
        .withFailureHandler(function (error) {
          showToast(`Error loading classrooms: ${error.message}`, 'error');
        })
        .getClassrooms();
    });

    function populateForm(data) {
      document.getElementById('apiKey').value = data.apiKey || '';
      document.getElementById('backendUrl').value = data.backendUrl || '';
      document.getElementById('batchSize').value = data.batchSize || 20;
      document.getElementById('updateDetailsUrl').value = data.updateDetailsUrl || '';
      document.getElementById('assessmentRecordTemplateId').value = data.assessmentRecordTemplateId || '';
      document.getElementById('assessmentRecordDestinationFolder').value = data.assessmentRecordDestinationFolder || '';
      document.getElementById('daysUntilAuthRevoke').value = data.daysUntilAuthRevoke || 60;
    }

    function populateClassrooms(classrooms) {
      const select = document.getElementById('classrooms');
      if (!classrooms || classrooms.length === 0) {
        console.warn("No classrooms found.");
        return;
      }

      // Clear existing options except the first placeholder
      const options = select.querySelectorAll('md-select-option:not([disabled])');
      options.forEach(option => option.remove());

      // Add new options
      classrooms.forEach(classroom => {
        const option = document.createElement('md-select-option');
        option.value = classroom.id;
        option.dataset.name = classroom.name;
        option.innerHTML = `<div slot="headline">${classroom.name}</div>`;
        select.appendChild(option);
      });
    }

    // Simple toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 4px;
        color: white;
        z-index: 10000;
        background-color: ${type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3'};
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    document.getElementById('config-form').addEventListener('submit', function (event) {
      event.preventDefault();

      const select = document.getElementById('classrooms');
      const selectedOption = select.querySelector(`md-select-option[value="${select.value}"]`);
      const classroom = select.value ? {
        courseId: select.value,
        courseName: selectedOption ? selectedOption.dataset.name : ''
      } : null;

      const formData = {
        apiKey: document.getElementById('apiKey').value.trim(),
        backendUrl: document.getElementById('backendUrl').value.trim(),
        batchSize: parseInt(document.getElementById('batchSize').value, 10),
        updateDetailsUrl: document.getElementById('updateDetailsUrl').value.trim(),
        assessmentRecordTemplateId: document.getElementById('assessmentRecordTemplateId').value.trim(),
        assessmentRecordDestinationFolder: document.getElementById('assessmentRecordDestinationFolder').value.trim(),
        daysUntilAuthRevoke: parseInt(document.getElementById('daysUntilAuthRevoke').value, 10),
        classroom: classroom
      };

      google.script.run
        .withSuccessHandler(function () {
          showToast('Configuration saved successfully.', 'success');
          google.script.host.close();
        })
        .withFailureHandler(function (error) {
          showToast(`Error saving configuration: ${error.message}`, 'error');
        })
        .saveConfiguration(formData);
    });
  </script>
</body>

</html>