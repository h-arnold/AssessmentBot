<!-- ProgressModal.html -->
<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" href="../ui/assets/material-web.css">
    <style>
        body {
            padding: 20px;
        }

        #progress-bar {
            margin-top: 20px;
        }

        #status-message {
            margin-top: 10px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    
    <div id="progress-bar">
        <md-linear-progress indeterminate></md-linear-progress>
    </div>
    <div id="status-message">Initialising...</div>

    <script src="../ui/assets/material-web.js"></script>
    <script>
        /**
         * Polls the server for progress updates every 2 seconds.
         */
        function startPolling() {
            // Initial fetch
            fetchStatus();
            // Set interval to fetch status every 2 seconds
            window.pollingInterval = setInterval(fetchStatus, 2000);
        }

        /**
         * Fetches the current status from the server.
         */
        function fetchStatus() {
            google.script.run
                .withSuccessHandler(updateProgress)
                .withFailureHandler(handleError)
                .requestStatus();
        }

        /**
         * Updates the progress bar and status message based on the server response.
         *
         * @param {Object} progress - The progress data from the server.
         */
        function updateProgress(progress) {
            const statusMessage = document.getElementById('status-message');
            const progressBar = document.querySelector('#progress-bar md-linear-progress');

            if (progress.error) {
                clearInterval(window.pollingInterval);
                statusMessage.textContent = `Error: ${progress.error}`;
                statusMessage.className = 'red';
                progressBar.removeAttribute('indeterminate');
                progressBar.value = 1;
                return;
            }

            statusMessage.textContent = `Step ${progress.step}: ${progress.message}`;

            if (progress.completed) {
                clearInterval(window.pollingInterval);
                statusMessage.textContent += ' (Completed)';
                statusMessage.className = 'green';
                progressBar.removeAttribute('indeterminate');
                progressBar.value = 1;

                // Optionally, close the modal after a short delay
                setTimeout(() => {
                    google.script.host.close();
                }, 2000);
            }
        }

        /**
         * Handles errors during the progress fetch.
         *
         * @param {Object} error - The error object.
         */
        function handleError(error) {
            clearInterval(window.pollingInterval);
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = `Error fetching progress: ${error.message}`;
            statusMessage.className = 'red';
            const progressBar = document.querySelector('#progress-bar md-linear-progress');
            progressBar.removeAttribute('indeterminate');
            progressBar.value = 1;
        }

        // Start polling when the modal loads
        document.addEventListener('DOMContentLoaded', startPolling);
    </script>
</body>

</html>