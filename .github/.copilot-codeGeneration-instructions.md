# AssessmentBot Code Schema

## Project

- TYPE: Google Apps Script assessment tool
- DOMAIN: Education, Google Classroom
- FUNCTION: Evaluate student slide submissions against references
- ASSESSMENT_CRITERIA: {Completeness, Accuracy, SPaG}
- MARKERS: {Text:"#", Images:"~|"}
- DATA_STORAGE: Google Sheets
- COMPLIANCE: GDPR (data within Google Workspace)

## Architecture

- FRONTEND: Google Apps Script
- BACKEND: [Assessment Bot Backend](https://github.com/h-arnold/AssessmentBot-Backend)
- STORAGE: Google Sheets - soon to be [JsonDBApp](https://github.com/h-arnold/JsonDbApp)

## Code_Standards

ALL NAMES: Prefer full words; avoid abbreviations unless widely recognised.

- CLASS_NAMING: PascalCase
- METHOD_NAMING: camelCase
- VARIABLE_NAMING: camelCase
- CONSTANTS: const
- VARIABLES: let
- LANGUAGE: British English
- INDENTATION: 2 spaces
- PATHS:
  - CORE: /src/frontend/BaseClassFolder
  - CONTROLLERS: /src/frontend/z_Controllers
- LOAD_ORDER: numeric prefixes (0BaseSheetManager.js)

## Implementation_Patterns

- INSTANTIATION: lazy
- DESIGN: dependency injection
- METHODS: small, focused
- SERVICES: singletons (/src/frontend/singletons.js)
- ERROR_HANDLING:
  - USER_FACING: this.progressTracker.logError(errorMessage, extraErrorDetails)
  - DEV_FACING: Only use console.error for non-user-facing errors. Do not duplicate console.error after logError; pass extra details to logError as the second parameter for developer logs.
  - STRUCTURE: try/catch blocks

## Documentation

- FORMAT: JSDoc
- COMPONENTS: {description, @param, @return, @remarks}
- STYLE: British English
- INLINE: for complex logic

## Google_APIs

- SPREADSHEETS: SpreadsheetApp
- SLIDES: SlidesApp
- FILES: DriveApp
- CLASSROOM: ClassroomApp
- OPTIMIZATION: batch operations
- LIMITS: handle rate limits and quotas

## Security

- INPUT: validate all
- CALLS: minimize API usage
- PERFORMANCE: implement caching
- AUTH: verify permissions
- DATA: keep within Google Workspace
- PRIVACY: GDPR compliant

## Important Notes

- Only implement the code requested.
- Ask for clarification if the request is ambiguous.
- Check for existing code before creating new methods.
- Always write in British English.
- Update code with British English spelling if you find American English.

## Testing Framework (Local, Non-GAS)

- FRAMEWORK: Vitest (lightweight Jest-compatible runner)
- CONFIG: `vitest.config.js` (plain object export, avoids Vite ESM import)
- SETUP FILE: `tests/setupGlobals.js`
  - Provides shims: `Utils.generateHash`, `Utilities.base64Encode`, `Logger.log`.
  - Exposes `ArtifactFactory` globally for models referencing it indirectly.
- TEST LOCATION: `tests/**/*.test.js`
- COMMANDS:
  - Run once: `npm test` (alias for `vitest run`)
  - Watch mode: `npm run test:watch`
- SCOPE: Only pure logic / model code. Do NOT invoke Google Apps Script APIs (SlidesApp, DriveApp, etc.).
- STUBBING: If a model needs a GAS value, refactor to accept primitives or inject a stub object created inside the test.
- HASH STABILITY: Tests assume hash function is deterministic; avoid assertions on specific hash strings, only truthiness / inequality for changed content.
- ARTIFACTS: All artifact tests should use primitive content (strings, arrays, Uint8Array for images) to keep environment independent of GAS.
- SERIALISATION: Round-trip tests must use `toJSON()` / `fromJSON()` onlyâ€”avoid deep cloning tricks that depend on execution context.
- NEW TESTS: When adding a new model or feature, include at least: normalisation behaviour, hashing consistency, JSON round-trip, and edge cases (empty, null, large input where applicable).
- PROHIBITED IN TESTS: Direct use of Apps Script services, network calls, timers reliant on GAS environment.
- FUTURE EXTENSION: Add coverage by installing `@vitest/coverage-v8` and running `vitest run --coverage` (not yet configured).

## Singleton loading pattern (BaseSingleton fallback)

When authoring new singleton classes that inherit from `BaseSingleton`, follow this minimal fallback pattern:

- Keep the canonical implementation in `src/AdminSheet/00_BaseSingleton.js` (loaded first in GAS). This file should contain the full behaviour (getInstance, _createInstance, resetForTests, _maybeFreeze, etc.).
- In singleton files (e.g. `ConfigurationManager`, `ProgressTracker`) do NOT duplicate the full BaseSingleton implementation. Instead include a tiny, idempotent fallback only to avoid runtime reference errors when a file is imported in isolation during tests.

Example minimal fallback (copy into singleton files before declaring `class X extends BaseSingleton`):

```javascript
// BaseSingleton is provided by 00_BaseSingleton.js (loaded first in GAS). For safety during
// isolated module tests or partial imports, provide a minimal fallback only if absent.
if (typeof globalThis.BaseSingleton === 'undefined') {
  globalThis.BaseSingleton = class {
    static getInstance() {
      if (!this._instance) this._instance = new this(true);
      return this._instance;
    }
    static _maybeFreeze(_) { /* noop fallback - real implementation lives in 00_BaseSingleton.js */ }
  };
}
```

Notes:
- The fallback must be intentionally tiny and must not implement test helpers like `resetForTests` or freezing behaviour beyond a safe no-op. Keep test-only helpers in `00_BaseSingleton.js` or in dedicated test bootstrap files.
- In tests that need the full behaviour, prefer importing `src/AdminSheet/00_BaseSingleton.js` early in the test bootstrap (e.g. `tests/setupGlobals.js`) so the fallback is never used.
- This pattern avoids SyntaxError risks in GAS (no lexical redeclarations) while keeping production singleton behaviour centralised and easy to maintain.

